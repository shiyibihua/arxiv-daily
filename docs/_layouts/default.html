<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <title>{{ page.title }}</title>
  <link rel="stylesheet" href="{{ '/assets/style.css' | relative_url }}">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <nav class="top-nav">
    <div class="nav-container">
      <a href="{{ '/' | relative_url }}" class="nav-brand">ğŸ“š arXiv Daily</a>
      <div class="nav-links">
        <a href="{{ '/' | relative_url }}#cs-RO" class="nav-link">ğŸ¤– cs.RO</a>
        <a href="{{ '/' | relative_url }}#cs-CV" class="nav-link">ğŸ‘ï¸ cs.CV</a>
        <a href="{{ '/' | relative_url }}#cs-GR" class="nav-link">ğŸ¨ cs.GR</a>
        <button class="nav-favorites" onclick="showFavorites()">
          â­ æ”¶è—å¤¹ <span id="favorites-count" class="favorites-badge" style="display:none">0</span>
        </button>
      </div>
    </div>
  </nav>

  <main class="container">
    {{ content }}
  </main>

  <footer class="footer">
    <p>Powered by GitHub Pages Â· Generated on {{ site.time | date: "%Y-%m-%d" }}</p>
  </footer>

  <!-- æ”¶è—å¤¹å¼¹çª— -->
  <div id="favorites-modal" class="modal-overlay" onclick="if(event.target===this)closeFavorites()">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3>â­ æˆ‘çš„æ”¶è—</h3>
        <button class="modal-close" onclick="closeFavorites()">âœ•</button>
      </div>
      <div class="folder-tabs" id="folder-tabs"></div>
      <div class="modal-body" id="favorites-list"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="showManageFolders()">âš™ï¸ ç®¡ç†</button>
        <button class="btn btn-secondary" onclick="exportFavorites()">ğŸ“¤ å¯¼å‡º</button>
      </div>
    </div>
  </div>

  <!-- æ–°å»ºæ”¶è—å¤¹å¼¹çª— -->
  <div id="new-folder-modal" class="modal-overlay" onclick="if(event.target===this)closeNewFolderModal()">
    <div class="modal-content" style="max-width:400px">
      <div class="modal-header">
        <h3>ğŸ“ æ–°å»ºæ”¶è—å¤¹</h3>
        <button class="modal-close" onclick="closeNewFolderModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>åç§°</label>
          <input type="text" id="new-folder-name" placeholder="å¦‚ï¼šå¾…è¯»è®ºæ–‡" maxlength="20">
        </div>
        <div class="form-group">
          <label>é¢œè‰²</label>
          <div class="color-picker" id="color-picker"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeNewFolderModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="createFolder()">åˆ›å»º</button>
      </div>
    </div>
  </div>

  <!-- ç®¡ç†æ”¶è—å¤¹å¼¹çª— -->
  <div id="manage-folders-modal" class="modal-overlay" onclick="if(event.target===this)closeManageFolders()">
    <div class="modal-content" style="max-width:450px">
      <div class="modal-header">
        <h3>âš™ï¸ ç®¡ç†æ”¶è—å¤¹</h3>
        <button class="modal-close" onclick="closeManageFolders()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="manage-folders" id="manage-folders-list"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="closeManageFolders()">å®Œæˆ</button>
      </div>
    </div>
  </div>

  <script>
    // æ”¶è—å¤¹é¢œè‰²é€‰é¡¹
    var FOLDER_COLORS = ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];

    // é»˜è®¤æ”¶è—å¤¹
    var DEFAULT_FOLDERS = [{ id: 'default', name: 'é»˜è®¤æ”¶è—', color: '#2563eb', system: true }];

    // è·å–æ”¶è—å¤¹åˆ—è¡¨
    function getFolders() {
      try {
        var data = localStorage.getItem('arxiv_folders');
        return data ? JSON.parse(data) : DEFAULT_FOLDERS.slice();
      } catch (e) { return DEFAULT_FOLDERS.slice(); }
    }

    // ä¿å­˜æ”¶è—å¤¹åˆ—è¡¨
    function saveFolders(folders) {
      localStorage.setItem('arxiv_folders', JSON.stringify(folders));
    }

    // è·å–æ”¶è—
    function getFavorites() {
      try {
        var data = localStorage.getItem('arxiv_favorites');
        return data ? JSON.parse(data) : [];
      } catch (e) { return []; }
    }

    // ä¿å­˜æ”¶è—
    function saveFavorites(favs) {
      localStorage.setItem('arxiv_favorites', JSON.stringify(favs));
      updateFavoriteCount();
    }

    // æ›´æ–°æ”¶è—è®¡æ•°
    function updateFavoriteCount() {
      var count = getFavorites().length;
      var badge = document.getElementById('favorites-count');
      if (badge) {
        badge.textContent = count;
        badge.style.display = count > 0 ? 'inline' : 'none';
      }
    }

    // æ·»åŠ åˆ°æ”¶è—å¤¹
    function addToFolder(arxivId, title, folderId) {
      var favs = getFavorites();
      var idx = -1;
      for (var i = 0; i < favs.length; i++) {
        if (favs[i].id === arxivId) { idx = i; break; }
      }
      if (idx >= 0) favs.splice(idx, 1);
      favs.push({
        id: arxivId,
        title: title,
        folder: folderId,
        time: new Date().toISOString()
      });
      saveFavorites(favs);
      updatePageFavorites();
    }

    // ä»æ”¶è—å¤¹ç§»é™¤
    function removeFromFavorites(arxivId) {
      var favs = getFavorites().filter(function (f) { return f.id !== arxivId; });
      saveFavorites(favs);
      updatePageFavorites();
    }

    // è·å–è®ºæ–‡æ‰€åœ¨æ”¶è—å¤¹
    function getPaperFolder(arxivId) {
      var favs = getFavorites();
      for (var i = 0; i < favs.length; i++) {
        if (favs[i].id === arxivId) return favs[i].folder;
      }
      return null;
    }

    // æ›´æ–°é¡µé¢ä¸Šçš„æ”¶è—æŒ‰é’®çŠ¶æ€
    function updatePageFavorites() {
      var btns = document.querySelectorAll('.favorite-btn, .toolbar-btn.favorite-btn');
      btns.forEach(function (btn) {
        var arxivId = btn.getAttribute('data-arxiv-id');
        if (arxivId) {
          var folderId = getPaperFolder(arxivId);
          if (folderId) {
            btn.classList.add('favorited');
            if (btn.classList.contains('toolbar-btn')) {
              btn.innerHTML = 'â­ å·²æ”¶è—';
            } else {
              btn.textContent = 'â­';
            }
          } else {
            btn.classList.remove('favorited');
            if (btn.classList.contains('toolbar-btn')) {
              btn.innerHTML = 'â˜† æ”¶è—';
            } else {
              btn.textContent = 'â˜†';
            }
          }
        }
      });
      updateFavoriteCount();
    }

    // æ˜¾ç¤ºæ”¶è—å¤¹é€‰æ‹©èœå•
    function showFolderMenu(btn, arxivId, title) {
      // ç§»é™¤å·²æœ‰èœå•
      var oldMenus = document.querySelectorAll('.folder-menu');
      oldMenus.forEach(function (m) { m.remove(); });

      var folders = getFolders();
      var currentFolder = getPaperFolder(arxivId);
      var safeTitle = title.replace(/'/g, "\\'").replace(/"/g, '\\"');

      var menu = document.createElement('div');
      menu.className = 'folder-menu';

      var html = '<div class="folder-menu-title">é€‰æ‹©æ”¶è—å¤¹</div>';
      for (var i = 0; i < folders.length; i++) {
        var f = folders[i];
        var isActive = f.id === currentFolder ? 'active' : '';
        var checkMark = f.id === currentFolder ? '<span class="folder-check">âœ“</span>' : '';
        html += '<div class="folder-menu-item ' + isActive + '" onclick="selectFolder(\'' + arxivId + '\',\'' + safeTitle + '\',\'' + f.id + '\')">' +
          '<span class="folder-dot" style="background:' + f.color + '"></span>' +
          '<span>' + f.name + '</span>' + checkMark + '</div>';
      }
      html += '<div class="folder-menu-divider"></div>';
      html += '<div class="folder-menu-item" onclick="showNewFolderModal(\'' + arxivId + '\',\'' + safeTitle + '\')">' +
        '<span style="color:var(--primary)">ï¼‹ æ–°å»ºæ”¶è—å¤¹</span></div>';

      if (currentFolder) {
        html += '<div class="folder-menu-divider"></div>';
        html += '<div class="folder-menu-item remove" onclick="removeFromFavorites(\'' + arxivId + '\');closeFolderMenu()">' +
          '<span>âœ• å–æ¶ˆæ”¶è—</span></div>';
      }

      menu.innerHTML = html;

      var rect = btn.getBoundingClientRect();
      menu.style.position = 'fixed';
      menu.style.top = (rect.bottom + 5) + 'px';
      menu.style.left = Math.min(rect.left, window.innerWidth - 180) + 'px';

      document.body.appendChild(menu);

      setTimeout(function () {
        document.addEventListener('click', closeFolderMenuOnClick);
      }, 10);
    }

    function closeFolderMenuOnClick(e) {
      if (!e.target.closest('.folder-menu') && !e.target.closest('.favorite-btn')) {
        closeFolderMenu();
        document.removeEventListener('click', closeFolderMenuOnClick);
      }
    }

    function closeFolderMenu() {
      var menus = document.querySelectorAll('.folder-menu');
      menus.forEach(function (m) { m.remove(); });
      document.removeEventListener('click', closeFolderMenuOnClick);
    }

    function selectFolder(arxivId, title, folderId) {
      addToFolder(arxivId, title, folderId);
      closeFolderMenu();
    }

    // æ”¶è—æŒ‰é’®ç‚¹å‡»å¤„ç†
    function toggleFavorite(btn, arxivId, title) {
      showFolderMenu(btn, arxivId, title);
    }

    // æ˜¾ç¤ºæ”¶è—å¤¹å¼¹çª—
    var currentViewFolder = 'all';
    function showFavorites() {
      renderFolderTabs();
      renderFavoritesList();
      document.getElementById('favorites-modal').style.display = 'flex';
    }

    function closeFavorites() {
      document.getElementById('favorites-modal').style.display = 'none';
    }

    function renderFolderTabs() {
      var folders = getFolders();
      var favs = getFavorites();
      var container = document.getElementById('folder-tabs');

      var allCount = favs.length;
      var html = '<button class="folder-tab ' + (currentViewFolder === 'all' ? 'active' : '') + '" onclick="switchFolder(\'all\')">' +
        'å…¨éƒ¨ <span class="folder-count">' + allCount + '</span></button>';

      for (var i = 0; i < folders.length; i++) {
        var f = folders[i];
        var count = favs.filter(function (fav) { return fav.folder === f.id; }).length;
        html += '<button class="folder-tab ' + (currentViewFolder === f.id ? 'active' : '') + '" ' +
          'style="--folder-color:' + f.color + '" onclick="switchFolder(\'' + f.id + '\')">' +
          f.name + ' <span class="folder-count">' + count + '</span></button>';
      }

      container.innerHTML = html;
    }

    function switchFolder(folderId) {
      currentViewFolder = folderId;
      renderFolderTabs();
      renderFavoritesList();
    }

    function renderFavoritesList() {
      var folders = getFolders();
      var favs = getFavorites();

      if (currentViewFolder !== 'all') {
        favs = favs.filter(function (f) { return f.folder === currentViewFolder; });
      }

      var container = document.getElementById('favorites-list');

      if (favs.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:var(--text-secondary);padding:2rem">æš‚æ— æ”¶è—</p>';
        return;
      }

      // æŒ‰æ—¶é—´å€’åº
      favs.sort(function (a, b) { return new Date(b.time) - new Date(a.time); });

      var html = '';
      for (var i = 0; i < favs.length; i++) {
        var fav = favs[i];
        var folder = null;
        for (var j = 0; j < folders.length; j++) {
          if (folders[j].id === fav.folder) { folder = folders[j]; break; }
        }
        if (!folder) folder = { name: 'æœªçŸ¥', color: '#888' };

        html += '<div class="favorite-item">' +
          '<a href="https://arxiv.org/abs/' + fav.id + '" target="_blank" class="favorite-title">' + fav.title + '</a>' +
          '<div class="favorite-meta">' +
          '<span><span class="folder-dot" style="background:' + folder.color + ';display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:4px"></span>' + folder.name + ' Â· ' + fav.id + '</span>' +
          '<button class="remove-favorite" onclick="removeFromFavorites(\'' + fav.id + '\');renderFavoritesList()">åˆ é™¤</button>' +
          '</div></div>';
      }
      container.innerHTML = html;
    }

    // æ–°å»ºæ”¶è—å¤¹
    var pendingPaper = null;
    function showNewFolderModal(arxivId, title) {
      closeFolderMenu();
      pendingPaper = arxivId ? { id: arxivId, title: title } : null;
      document.getElementById('new-folder-name').value = '';
      renderColorPicker();
      document.getElementById('new-folder-modal').style.display = 'flex';
    }

    function closeNewFolderModal() {
      document.getElementById('new-folder-modal').style.display = 'none';
      pendingPaper = null;
    }

    var selectedColor = FOLDER_COLORS[0];
    function renderColorPicker() {
      var container = document.getElementById('color-picker');
      var html = '';
      for (var i = 0; i < FOLDER_COLORS.length; i++) {
        var c = FOLDER_COLORS[i];
        html += '<button class="color-btn ' + (c === selectedColor ? 'selected' : '') + '" style="background:' + c + '" onclick="selectColor(\'' + c + '\')"></button>';
      }
      container.innerHTML = html;
    }

    function selectColor(color) {
      selectedColor = color;
      renderColorPicker();
    }

    function createFolder() {
      var name = document.getElementById('new-folder-name').value.trim();
      if (!name) { alert('è¯·è¾“å…¥æ”¶è—å¤¹åç§°'); return; }

      var folders = getFolders();
      for (var i = 0; i < folders.length; i++) {
        if (folders[i].name === name) { alert('è¯¥åç§°å·²å­˜åœ¨'); return; }
      }

      var newFolder = {
        id: 'folder_' + Date.now(),
        name: name,
        color: selectedColor,
        system: false
      };
      folders.push(newFolder);
      saveFolders(folders);

      if (pendingPaper) {
        addToFolder(pendingPaper.id, pendingPaper.title, newFolder.id);
      }

      closeNewFolderModal();

      if (document.getElementById('favorites-modal').style.display === 'flex') {
        renderFolderTabs();
        renderFavoritesList();
      }
    }

    // ç®¡ç†æ”¶è—å¤¹
    function showManageFolders() {
      renderManageFoldersList();
      document.getElementById('manage-folders-modal').style.display = 'flex';
    }

    function closeManageFolders() {
      document.getElementById('manage-folders-modal').style.display = 'none';
    }

    function renderManageFoldersList() {
      var folders = getFolders();
      var favs = getFavorites();
      var container = document.getElementById('manage-folders-list');

      var html = '';
      for (var i = 0; i < folders.length; i++) {
        var f = folders[i];
        var count = favs.filter(function (fav) { return fav.folder === f.id; }).length;
        html += '<div class="manage-folder-item">' +
          '<span class="folder-dot" style="background:' + f.color + '"></span>' +
          '<span class="folder-name">' + f.name + '</span>' +
          '<span class="folder-count">(' + count + ')</span>';
        if (!f.system) {
          html += '<button class="remove-folder" onclick="deleteFolder(\'' + f.id + '\')">åˆ é™¤</button>';
        }
        html += '</div>';
      }

      html += '<button class="btn btn-secondary" style="margin-top:0.5rem" onclick="showNewFolderModal()">ï¼‹ æ–°å»ºæ”¶è—å¤¹</button>';
      container.innerHTML = html;
    }

    function deleteFolder(folderId) {
      if (!confirm('åˆ é™¤è¯¥æ”¶è—å¤¹ï¼Ÿæ”¶è—çš„è®ºæ–‡å°†ç§»è‡³é»˜è®¤æ”¶è—å¤¹')) return;

      var favs = getFavorites();
      for (var i = 0; i < favs.length; i++) {
        if (favs[i].folder === folderId) favs[i].folder = 'default';
      }
      saveFavorites(favs);

      var folders = getFolders().filter(function (f) { return f.id !== folderId; });
      saveFolders(folders);

      renderManageFoldersList();
      renderFolderTabs();
      renderFavoritesList();
    }

    // å¯¼å‡ºæ”¶è—
    function exportFavorites() {
      var favs = getFavorites();
      if (favs.length === 0) { alert('æš‚æ— æ”¶è—å¯å¯¼å‡º'); return; }

      var folders = getFolders();
      var text = '# arXiv Daily æ”¶è—å¯¼å‡º\n';
      text += '# å¯¼å‡ºæ—¶é—´: ' + new Date().toLocaleString() + '\n\n';

      for (var i = 0; i < folders.length; i++) {
        var folder = folders[i];
        var folderFavs = favs.filter(function (f) { return f.folder === folder.id; });
        if (folderFavs.length > 0) {
          text += '## ' + folder.name + '\n\n';
          for (var j = 0; j < folderFavs.length; j++) {
            var f = folderFavs[j];
            text += '- ' + f.title + '\n  https://arxiv.org/abs/' + f.id + '\n\n';
          }
        }
      }

      var blob = new Blob([text], { type: 'text/plain' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'arxiv_favorites.txt';
      a.click();
      URL.revokeObjectURL(url);
    }

    // å¤åˆ¶é“¾æ¥
    function copyLinkToClipboard(btn) {
      var url = window.location.href;
      navigator.clipboard.writeText(url).then(function () {
        btn.classList.add('copied');
        var orig = btn.innerHTML;
        btn.innerHTML = 'âœ“ å·²å¤åˆ¶';
        setTimeout(function () {
          btn.classList.remove('copied');
          btn.innerHTML = orig;
        }, 1500);
      });
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
      updateFavoriteCount();
      updatePageFavorites();

      // è®©å¤–éƒ¨é“¾æ¥åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€
      var links = document.querySelectorAll('a[href]');
      links.forEach(function (link) {
        var href = link.getAttribute('href');
        if (href && (
          href.indexOf('http') === 0 ||
          href.indexOf('arxiv.org') >= 0 ||
          href.indexOf('github.com') >= 0 ||
          href.indexOf('.pdf') >= 0
        )) {
          link.setAttribute('target', '_blank');
          link.setAttribute('rel', 'noopener noreferrer');
        }
      });
    });
  </script>
</body>

</html>
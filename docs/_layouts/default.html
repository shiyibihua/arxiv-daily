<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<title>{{ page.title }}</title>
<link rel="stylesheet" href="{{ '/assets/style.css' | relative_url }}">
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<nav class="top-nav">
  <div class="nav-container">
    <a href="{{ '/' | relative_url }}" class="nav-brand">ğŸ“š arXiv Daily</a>
    <div class="nav-links">
      <a href="{{ '/' | relative_url }}#cs-RO" class="nav-link">ğŸ¤– cs.RO</a>
      <a href="{{ '/' | relative_url }}#cs-CV" class="nav-link">ğŸ‘ï¸ cs.CV</a>
      <a href="{{ '/' | relative_url }}#cs-GR" class="nav-link">ğŸ¨ cs.GR</a>
      <button class="nav-favorites" onclick="showFavorites()">
        â­ æ”¶è—å¤¹ <span id="favorites-count" class="favorites-badge" style="display:none">0</span>
      </button>
    </div>
  </div>
</nav>
<main class="container">
  {{ content }}
</main>
<footer class="footer">
  <p>Powered by GitHub Pages Â· Generated on {{ site.time | date: "%Y-%m-%d" }}</p>
</footer>

<script>
// ===== å¤šæ”¶è—å¤¹åŠŸèƒ½ =====
const STORAGE_KEY = 'arxiv_collections';

// é¢„è®¾é¢œè‰²
const FOLDER_COLORS = ['#f59e0b', '#3b82f6', '#ef4444', '#10b981', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];

// è·å–æ‰€æœ‰æ•°æ®
function getData() {
  try {
    const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
    if (data && data.folders && data.papers) return data;
  } catch (e) {}
  // é»˜è®¤æ•°æ®ç»“æ„
  return {
    folders: {
      'default': { name: 'é»˜è®¤æ”¶è—', color: '#f59e0b', order: 0 },
      'reading': { name: 'å¾…è¯»', color: '#3b82f6', order: 1 },
      'important': { name: 'é‡è¦', color: '#ef4444', order: 2 }
    },
    papers: {}
  };
}

// ä¿å­˜æ•°æ®
function saveData(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

// ç‚¹å‡»æ”¶è—æŒ‰é’® - æ˜¾ç¤ºæ”¶è—å¤¹é€‰æ‹©èœå•
function toggleFavorite(btn, arxivId, title) {
  // å…³é—­å…¶ä»–æ‰“å¼€çš„èœå•
  document.querySelectorAll('.folder-menu').forEach(m => m.remove());
  
  const data = getData();
  const paper = data.papers[arxivId];
  
  // åˆ›å»ºæ”¶è—å¤¹é€‰æ‹©èœå•
  const menu = document.createElement('div');
  menu.className = 'folder-menu';
  
  const folders = Object.entries(data.folders)
    .sort((a, b) => a[1].order - b[1].order);
  
  let menuHtml = '<div class="folder-menu-title">é€‰æ‹©æ”¶è—å¤¹</div>';
  
  folders.forEach(([folderId, folder]) => {
    const isInFolder = paper && paper.folder === folderId;
    menuHtml += `
      <div class="folder-menu-item ${isInFolder ? 'active' : ''}" 
           onclick="addToFolder('${arxivId}', '${folderId}', '${title.replace(/'/g, "\\'")}', this)">
        <span class="folder-dot" style="background:${folder.color}"></span>
        ${folder.name}
        ${isInFolder ? '<span class="folder-check">âœ“</span>' : ''}
      </div>
    `;
  });
  
  menuHtml += `
    <div class="folder-menu-divider"></div>
    <div class="folder-menu-item" onclick="showNewFolderDialog('${arxivId}', '${title.replace(/'/g, "\\'")}')">
      <span class="folder-dot" style="background:#999">+</span>
      æ–°å»ºæ”¶è—å¤¹...
    </div>
  `;
  
  if (paper) {
    menuHtml += `
      <div class="folder-menu-divider"></div>
      <div class="folder-menu-item remove" onclick="removeFromFavorites('${arxivId}')">
        ç§»é™¤æ”¶è—
      </div>
    `;
  }
  
  menu.innerHTML = menuHtml;
  
  // å®šä½èœå•
  const rect = btn.getBoundingClientRect();
  menu.style.position = 'fixed';
  menu.style.top = (rect.bottom + 5) + 'px';
  menu.style.left = Math.min(rect.left, window.innerWidth - 180) + 'px';
  
  document.body.appendChild(menu);
  
  // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
  setTimeout(() => {
    document.addEventListener('click', closeFolderMenu);
  }, 10);
}

function closeFolderMenu(e) {
  if (!e || !e.target.closest('.folder-menu')) {
    document.querySelectorAll('.folder-menu').forEach(m => m.remove());
    document.removeEventListener('click', closeFolderMenu);
  }
}

// æ·»åŠ åˆ°æ”¶è—å¤¹
function addToFolder(arxivId, folderId, title, menuItem) {
  const data = getData();
  
  data.papers[arxivId] = {
    title: title,
    folder: folderId,
    addedAt: new Date().toISOString(),
    url: window.location.href
  };
  
  saveData(data);
  closeFolderMenu();
  updateButtonState(arxivId, data.folders[folderId].color);
  updateFavoriteCount();
}

// ä»æ”¶è—ç§»é™¤
function removeFromFavorites(arxivId) {
  const data = getData();
  delete data.papers[arxivId];
  saveData(data);
  closeFolderMenu();
  
  const btn = document.querySelector(`.favorite-btn[data-arxiv-id="${arxivId}"]`);
  if (btn) {
    btn.textContent = 'â˜†';
    btn.classList.remove('favorited');
    btn.style.color = '';
    btn.title = 'æ·»åŠ åˆ°æ”¶è—å¤¹';
  }
  updateFavoriteCount();
}

// æ›´æ–°æŒ‰é’®çŠ¶æ€
function updateButtonState(arxivId, color) {
  const btn = document.querySelector(`.favorite-btn[data-arxiv-id="${arxivId}"]`);
  if (btn) {
    btn.textContent = 'â˜…';
    btn.classList.add('favorited');
    btn.style.color = color;
    btn.title = 'ç®¡ç†æ”¶è—';
  }
}

// æ–°å»ºæ”¶è—å¤¹å¯¹è¯æ¡†
function showNewFolderDialog(arxivId, title) {
  closeFolderMenu();
  
  const modal = document.createElement('div');
  modal.id = 'new-folder-modal';
  modal.className = 'modal-overlay';
  modal.style.display = 'flex';
  
  const colorsHtml = FOLDER_COLORS.map((c, i) => 
    `<button type="button" class="color-btn ${i === 0 ? 'selected' : ''}" 
             style="background:${c}" data-color="${c}" 
             onclick="selectColor(this)"></button>`
  ).join('');
  
  modal.innerHTML = `
    <div class="modal-content" style="max-width:360px">
      <div class="modal-header">
        <h3>ğŸ“ æ–°å»ºæ”¶è—å¤¹</h3>
        <button class="modal-close" onclick="closeNewFolderDialog()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>æ”¶è—å¤¹åç§°</label>
          <input type="text" id="new-folder-name" placeholder="ä¾‹å¦‚ï¼šé¡¹ç›®å‚è€ƒã€å¾…å¤ç°..." autofocus>
        </div>
        <div class="form-group">
          <label>é€‰æ‹©é¢œè‰²</label>
          <div class="color-picker">${colorsHtml}</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeNewFolderDialog()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="createFolder('${arxivId}', '${title.replace(/'/g, "\\'")}')">åˆ›å»ºå¹¶æ”¶è—</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  document.body.style.overflow = 'hidden';
  document.getElementById('new-folder-name').focus();
}

function selectColor(btn) {
  document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
}

function closeNewFolderDialog() {
  const modal = document.getElementById('new-folder-modal');
  if (modal) {
    modal.remove();
    document.body.style.overflow = '';
  }
}

// åˆ›å»ºæ–°æ”¶è—å¤¹
function createFolder(arxivId, title) {
  const name = document.getElementById('new-folder-name').value.trim();
  if (!name) {
    alert('è¯·è¾“å…¥æ”¶è—å¤¹åç§°');
    return;
  }
  
  const colorBtn = document.querySelector('.color-btn.selected');
  const color = colorBtn ? colorBtn.dataset.color : FOLDER_COLORS[0];
  
  const data = getData();
  const folderId = 'folder_' + Date.now();
  const maxOrder = Math.max(...Object.values(data.folders).map(f => f.order || 0));
  
  data.folders[folderId] = { name, color, order: maxOrder + 1 };
  
  if (arxivId) {
    data.papers[arxivId] = {
      title: title,
      folder: folderId,
      addedAt: new Date().toISOString(),
      url: window.location.href
    };
  }
  
  saveData(data);
  closeNewFolderDialog();
  
  if (arxivId) {
    updateButtonState(arxivId, color);
  }
  updateFavoriteCount();
}

// é¡µé¢åŠ è½½æ—¶æ¢å¤æ”¶è—çŠ¶æ€
function restoreFavorites() {
  const data = getData();
  
  document.querySelectorAll('.favorite-btn').forEach(btn => {
    const arxivId = btn.getAttribute('data-arxiv-id');
    const paper = data.papers[arxivId];
    if (paper && data.folders[paper.folder]) {
      btn.textContent = 'â˜…';
      btn.classList.add('favorited');
      btn.style.color = data.folders[paper.folder].color;
      btn.title = 'ç®¡ç†æ”¶è—';
    }
  });
  updateFavoriteCount();
}

// æ›´æ–°æ”¶è—æ•°é‡
function updateFavoriteCount() {
  const data = getData();
  const count = Object.keys(data.papers).length;
  const badge = document.getElementById('favorites-count');
  if (badge) {
    badge.textContent = count;
    badge.style.display = count > 0 ? 'inline' : 'none';
  }
}

// æ˜¾ç¤ºæ”¶è—å¤¹ç®¡ç†å¼¹çª—
function showFavorites() {
  const data = getData();
  
  let modal = document.getElementById('favorites-modal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'favorites-modal';
    modal.className = 'modal-overlay';
    document.body.appendChild(modal);
  }
  
  const folders = Object.entries(data.folders).sort((a, b) => a[1].order - b[1].order);
  const papers = Object.entries(data.papers);
  
  // ç”Ÿæˆæ”¶è—å¤¹æ ‡ç­¾
  const tabsHtml = folders.map(([id, folder]) => {
    const count = papers.filter(([_, p]) => p.folder === id).length;
    return `<button class="folder-tab" data-folder="${id}" onclick="switchFolder('${id}')" 
                    style="--folder-color:${folder.color}">
              ${folder.name} <span class="folder-count">${count}</span>
            </button>`;
  }).join('');
  
  modal.innerHTML = `
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3>â­ æˆ‘çš„æ”¶è—å¤¹</h3>
        <button class="modal-close" onclick="closeFavorites()">âœ•</button>
      </div>
      <div class="folder-tabs">
        ${tabsHtml}
        <button class="folder-tab add-tab" onclick="showNewFolderDialog('', '')">+ æ–°å»º</button>
      </div>
      <div class="modal-body" id="folder-content">
        <p style="text-align:center;color:var(--text-secondary);padding:2rem;">
          é€‰æ‹©ä¸Šæ–¹çš„æ”¶è—å¤¹æŸ¥çœ‹å†…å®¹
        </p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="exportAllFavorites()">ğŸ“¤ å¯¼å‡ºå…¨éƒ¨</button>
        <button class="btn btn-secondary" onclick="manageFolders()">âš™ï¸ ç®¡ç†æ”¶è—å¤¹</button>
      </div>
    </div>
  `;
  
  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
  
  // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ªæ”¶è—å¤¹
  if (folders.length > 0) {
    switchFolder(folders[0][0]);
  }
}

// åˆ‡æ¢æ”¶è—å¤¹
function switchFolder(folderId) {
  const data = getData();
  const folder = data.folders[folderId];
  const papers = Object.entries(data.papers)
    .filter(([_, p]) => p.folder === folderId)
    .sort((a, b) => new Date(b[1].addedAt) - new Date(a[1].addedAt));
  
  // æ›´æ–°æ ‡ç­¾çŠ¶æ€
  document.querySelectorAll('.folder-tab').forEach(tab => {
    tab.classList.toggle('active', tab.dataset.folder === folderId);
  });
  
  const content = document.getElementById('folder-content');
  
  if (papers.length === 0) {
    content.innerHTML = `
      <p style="text-align:center;color:var(--text-secondary);padding:2rem;">
        è¿™ä¸ªæ”¶è—å¤¹è¿˜æ˜¯ç©ºçš„<br>
        <small>ç‚¹å‡»è®ºæ–‡åˆ—è¡¨ä¸­çš„ â˜† æ·»åŠ æ”¶è—</small>
      </p>
    `;
  } else {
    content.innerHTML = papers.map(([id, paper]) => `
      <div class="favorite-item">
        <a href="${paper.url}" class="favorite-title">${paper.title}</a>
        <div class="favorite-meta">
          <span>arXiv: ${id}</span>
          <span>${new Date(paper.addedAt).toLocaleDateString()}</span>
          <button class="remove-favorite" onclick="removePaper('${id}')">ç§»é™¤</button>
        </div>
      </div>
    `).join('');
  }
}

// ç§»é™¤è®ºæ–‡
function removePaper(arxivId) {
  const data = getData();
  const folderId = data.papers[arxivId]?.folder;
  delete data.papers[arxivId];
  saveData(data);
  
  const btn = document.querySelector(`.favorite-btn[data-arxiv-id="${arxivId}"]`);
  if (btn) {
    btn.textContent = 'â˜†';
    btn.classList.remove('favorited');
    btn.style.color = '';
  }
  
  if (folderId) switchFolder(folderId);
  updateFavoriteCount();
}

// ç®¡ç†æ”¶è—å¤¹
function manageFolders() {
  const data = getData();
  const folders = Object.entries(data.folders).sort((a, b) => a[1].order - b[1].order);
  
  const content = document.getElementById('folder-content');
  content.innerHTML = `
    <div class="manage-folders">
      ${folders.map(([id, folder]) => {
        const count = Object.values(data.papers).filter(p => p.folder === id).length;
        const isDefault = ['default', 'reading', 'important'].includes(id);
        return `
          <div class="manage-folder-item">
            <span class="folder-dot" style="background:${folder.color}"></span>
            <span class="folder-name">${folder.name}</span>
            <span class="folder-count">(${count}ç¯‡)</span>
            ${!isDefault ? `<button class="remove-folder" onclick="deleteFolder('${id}')">åˆ é™¤</button>` : ''}
          </div>
        `;
      }).join('')}
    </div>
  `;
}

// åˆ é™¤æ”¶è—å¤¹
function deleteFolder(folderId) {
  if (!confirm('åˆ é™¤æ­¤æ”¶è—å¤¹ï¼Ÿå…¶ä¸­çš„è®ºæ–‡å°†ç§»è‡³é»˜è®¤æ”¶è—ã€‚')) return;
  
  const data = getData();
  
  // å°†è®ºæ–‡ç§»è‡³é»˜è®¤æ”¶è—å¤¹
  Object.entries(data.papers).forEach(([id, paper]) => {
    if (paper.folder === folderId) {
      paper.folder = 'default';
    }
  });
  
  delete data.folders[folderId];
  saveData(data);
  
  showFavorites();
  restoreFavorites();
}

// å¯¼å‡ºå…¨éƒ¨
function exportAllFavorites() {
  const data = getData();
  let text = '';
  
  Object.entries(data.folders).forEach(([folderId, folder]) => {
    const papers = Object.entries(data.papers).filter(([_, p]) => p.folder === folderId);
    if (papers.length > 0) {
      text += `\n=== ${folder.name} ===\n\n`;
      papers.forEach(([id, paper]) => {
        text += `${paper.title}\nhttps://arxiv.org/abs/${id}\n\n`;
      });
    }
  });
  
  const blob = new Blob([text.trim()], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'arxiv_collections.txt';
  a.click();
  URL.revokeObjectURL(url);
}

// å…³é—­å¼¹çª—
function closeFavorites() {
  const modal = document.getElementById('favorites-modal');
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = '';
  }
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', restoreFavorites);

// ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('modal-overlay')) {
    closeFavorites();
    closeNewFolderDialog();
  }
});
</script>
</body>
</html>

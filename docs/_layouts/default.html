<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<title>{{ page.title }}</title>
<link rel="stylesheet" href="{{ '/assets/style.css' | relative_url }}">
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<nav class="top-nav">
  <div class="nav-container">
    <a href="{{ '/' | relative_url }}" class="nav-brand">ğŸ“š arXiv Daily</a>
    <div class="nav-links">
      <a href="{{ '/' | relative_url }}#cs-RO" class="nav-link">ğŸ¤– cs.RO</a>
      <a href="{{ '/' | relative_url }}#cs-CV" class="nav-link">ğŸ‘ï¸ cs.CV</a>
      <a href="{{ '/' | relative_url }}#cs-GR" class="nav-link">ğŸ¨ cs.GR</a>
      <button class="nav-favorites" onclick="showFavorites()">
        â­ æ”¶è—å¤¹ <span id="favorites-count" class="favorites-badge" style="display:none">0</span>
      </button>
    </div>
  </div>
</nav>
<main class="container">
  {{ content }}
</main>
<footer class="footer">
  <p>Powered by GitHub Pages Â· Generated on {{ site.time | date: "%Y-%m-%d" }}</p>
</footer>

<script>
// ===== æ”¶è—å¤¹åŠŸèƒ½ =====
const FAVORITES_KEY = 'arxiv_favorites';

// è·å–æ”¶è—åˆ—è¡¨
function getFavorites() {
  try {
    return JSON.parse(localStorage.getItem(FAVORITES_KEY)) || {};
  } catch (e) {
    return {};
  }
}

// ä¿å­˜æ”¶è—åˆ—è¡¨
function saveFavorites(favorites) {
  localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites));
}

// åˆ‡æ¢æ”¶è—çŠ¶æ€
function toggleFavorite(btn, arxivId, title) {
  const favorites = getFavorites();
  
  if (favorites[arxivId]) {
    // å–æ¶ˆæ”¶è—
    delete favorites[arxivId];
    btn.textContent = 'â˜†';
    btn.classList.remove('favorited');
    btn.title = 'æ·»åŠ åˆ°æ”¶è—å¤¹';
  } else {
    // æ·»åŠ æ”¶è—
    favorites[arxivId] = {
      title: title,
      addedAt: new Date().toISOString(),
      url: window.location.href
    };
    btn.textContent = 'â˜…';
    btn.classList.add('favorited');
    btn.title = 'å–æ¶ˆæ”¶è—';
  }
  
  saveFavorites(favorites);
  updateFavoriteCount();
}

// é¡µé¢åŠ è½½æ—¶æ¢å¤æ”¶è—çŠ¶æ€
function restoreFavorites() {
  const favorites = getFavorites();
  document.querySelectorAll('.favorite-btn').forEach(btn => {
    const arxivId = btn.getAttribute('data-arxiv-id');
    if (favorites[arxivId]) {
      btn.textContent = 'â˜…';
      btn.classList.add('favorited');
      btn.title = 'å–æ¶ˆæ”¶è—';
    }
  });
  updateFavoriteCount();
}

// æ›´æ–°æ”¶è—æ•°é‡æ˜¾ç¤º
function updateFavoriteCount() {
  const favorites = getFavorites();
  const count = Object.keys(favorites).length;
  const badge = document.getElementById('favorites-count');
  if (badge) {
    badge.textContent = count;
    badge.style.display = count > 0 ? 'inline' : 'none';
  }
}

// æ˜¾ç¤ºæ”¶è—å¤¹å¼¹çª—
function showFavorites() {
  const favorites = getFavorites();
  const entries = Object.entries(favorites);
  
  // åˆ›å»ºå¼¹çª—
  let modal = document.getElementById('favorites-modal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'favorites-modal';
    modal.className = 'modal-overlay';
    document.body.appendChild(modal);
  }
  
  if (entries.length === 0) {
    modal.innerHTML = `
      <div class="modal-content">
        <div class="modal-header">
          <h3>â­ æˆ‘çš„æ”¶è—å¤¹</h3>
          <button class="modal-close" onclick="closeFavorites()">âœ•</button>
        </div>
        <div class="modal-body">
          <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
            è¿˜æ²¡æœ‰æ”¶è—ä»»ä½•è®ºæ–‡<br>
            <small>ç‚¹å‡»è®ºæ–‡åˆ—è¡¨ä¸­çš„ â˜† æ·»åŠ æ”¶è—</small>
          </p>
        </div>
      </div>
    `;
  } else {
    const listHtml = entries
      .sort((a, b) => new Date(b[1].addedAt) - new Date(a[1].addedAt))
      .map(([id, data]) => `
        <div class="favorite-item">
          <a href="${data.url}" class="favorite-title">${data.title}</a>
          <div class="favorite-meta">
            <span>arXiv: ${id}</span>
            <button class="remove-favorite" onclick="removeFavorite('${id}')">ç§»é™¤</button>
          </div>
        </div>
      `).join('');
    
    modal.innerHTML = `
      <div class="modal-content">
        <div class="modal-header">
          <h3>â­ æˆ‘çš„æ”¶è—å¤¹ (${entries.length})</h3>
          <button class="modal-close" onclick="closeFavorites()">âœ•</button>
        </div>
        <div class="modal-body">
          ${listHtml}
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="exportFavorites()">ğŸ“¤ å¯¼å‡º</button>
          <button class="btn btn-secondary" onclick="clearFavorites()">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
      </div>
    `;
  }
  
  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

// å…³é—­æ”¶è—å¤¹å¼¹çª—
function closeFavorites() {
  const modal = document.getElementById('favorites-modal');
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = '';
  }
}

// ä»æ”¶è—å¤¹ç§»é™¤
function removeFavorite(arxivId) {
  const favorites = getFavorites();
  delete favorites[arxivId];
  saveFavorites(favorites);
  
  // æ›´æ–°é¡µé¢ä¸Šçš„æŒ‰é’®çŠ¶æ€
  const btn = document.querySelector(`.favorite-btn[data-arxiv-id="${arxivId}"]`);
  if (btn) {
    btn.textContent = 'â˜†';
    btn.classList.remove('favorited');
    btn.title = 'æ·»åŠ åˆ°æ”¶è—å¤¹';
  }
  
  // åˆ·æ–°å¼¹çª—
  showFavorites();
  updateFavoriteCount();
}

// å¯¼å‡ºæ”¶è—
function exportFavorites() {
  const favorites = getFavorites();
  const text = Object.entries(favorites)
    .map(([id, data]) => `${data.title}\nhttps://arxiv.org/abs/${id}\n`)
    .join('\n');
  
  const blob = new Blob([text], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'arxiv_favorites.txt';
  a.click();
  URL.revokeObjectURL(url);
}

// æ¸…ç©ºæ”¶è—
function clearFavorites() {
  if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ”¶è—å—ï¼Ÿ')) {
    localStorage.removeItem(FAVORITES_KEY);
    document.querySelectorAll('.favorite-btn').forEach(btn => {
      btn.textContent = 'â˜†';
      btn.classList.remove('favorited');
      btn.title = 'æ·»åŠ åˆ°æ”¶è—å¤¹';
    });
    closeFavorites();
    updateFavoriteCount();
  }
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', restoreFavorites);

// ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('modal-overlay')) {
    closeFavorites();
  }
});
</script>
</body>
</html>
